name: Gold Trend CN

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'run or status'
        required: false
        default: 'status'
  schedule:
    - cron: '0 13 * * 1-5'

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: pip install yfinance requests
      - name: Patch CN (phase 1)
        run: |
          python - <<'PY'
          p='gold_trend_bot.py'
          s=open(p,'r',encoding='utf-8').read()
          repl=[
            ('Gold Trend | Status','Gold Trend | \u72b6\u6001'),
            ('Price:','\u4ef7\u683c:')
          ]
          for a,b in repl:
              s=s.replace(a,b)
          open(p,'w',encoding='utf-8').write(s)
          print('patched phase1')
          PY
      - name: Patch CN (phase 2)
        run: |
          python - <<'PY'
          p='gold_trend_bot.py'
          s=open(p,'r',encoding='utf-8').read()
          repl=[
            ('Dynamic refs (ATR):','\u52a8\u6001\u53c2\u8003(ATR\u57fa\u51c6):'),
            ('Stops (pick one):','\u6b62\u635f\u4e09\u6863(\u62e9\u4e00\u6267\u884c):'),
            ('Conservative 1.0x','\u8c28\u614e 1.0x'),
            ('Standard    1.5x','\u6807\u51c6  1.5x'),
            ('Loose       2.0x','\u5bbd\u677e  2.0x'),
            ('How to use: if close < your stop -> cut 50â€“100% per plan.','\u7528\u6cd5: \u82e5\u6536\u76d8 < \u4f60\u9009\u5b9a\u7684\u6b62\u635f\u4ef7 -> \u4e25\u683c\u51cf\u4ed3 50\u2013100%\u3002'),
            ('--- Rules ---','--- \u89c4\u5219\u6458\u8981 ---'),
            ('*Buy bands*:','*\u4e70\u5165\u533a\u95f4*:'),
            ('-> target','-> \u76ee\u6807\u4ed3\u4f4d'),
            ('*Take profit*:','*\u6b62\u76c8\u76ee\u6807*:'),
            ('*Risk*:','*\u98ce\u9669\u63a7\u5236*:'),
            ('*Upper confirm*:','*\u4e0a\u6cbf\u786e\u8ba4*:'),
            ('(if holds, consider add to 70-80%)','(\u82e5\u4f01\u7a33, \u53ef\u8865\u81f3 70\u201380%)'),
            ('--- Realtime signals ---','\u2014\u2014 \u5b9e\u65f6\u4fe1\u53f7 \u2014\u2014')
          ]
          for a,b in repl:
              s=s.replace(a,b)
          open(p,'w',encoding='utf-8').write(s)
          print('patched phase2')
          PY
      - name: Run Bot (mode)
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python gold_trend_bot.py --mode "${{ github.event.inputs.mode || 'status' }}"
