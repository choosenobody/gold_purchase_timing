name: Gold Trend CN

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "run or status"
        required: false
        default: "status"
      symbol:
        description: "Override symbol (default GC=F)"
        required: false

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install yfinance requests

      - name: Patch bot messages to Chinese (lightweight)
        run: |
          python - << 'PY'
          import io, os

          path = "gold_trend_bot.py"
          with open(path, "r", encoding="utf-8") as f:
              s = f.read()

          # 仅改关键标题和标签，逻辑不变
          repl = [
              ("Gold Trend | Status", "黄金趋势 | 状态"),
              ("Gold Trend | Signals", "黄金趋势 | 信号"),
              ("Gold Trend | Heartbeat", "黄金趋势 | 心跳"),
              ("--- Plan ---", "--- 配置计划 ---"),
              ("--- Rules ---", "--- 交易规则 ---"),
              ("*Buy bands*:", "*买入区间*:"),
              ("*Take profit*:", "*止盈目标*:"),
              ("*Risk*:", "*风险控制*:"),
              ("*Upper confirm*:", "*上沿确认*:"),
              ("(if holds, consider add to 70-80%)", "(若企稳, 可补至 70–80%)"),
              ("--- Realtime signals ---", "—— 实时信号 ——"),
              ("RMB/g", "元/克"),
          ]

          for a, b in repl:
              s = s.replace(a, b)

          with open(path, "w", encoding="utf-8") as f:
              f.write(s)

          print("patched gold_trend_bot.py for CN output")
          PY

      - name: Run Gold Trend bot (CN)
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          MODE="${{ github.event.inputs.mode || 'status' }}"
          SYMBOL="${{ github.event.inputs.symbol || 'GC=F' }}"
          python gold_trend_bot.py --mode "${MODE}" --symbol "${SYMBOL}"
